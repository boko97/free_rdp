name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      - name: Check PowerShell Continuation & Syntax
        shell: pwsh
        run: |
          Write-Host "Runner is alive"
          Get-ComputerInfo | Select-Object OsName, OsVersion

      - name: Create Test User (no RDP exposure)
        shell: pwsh
        run: |
          Add-Type -AssemblyName System.Security

          $charSet = @{
            Upper   = [char[]](65..90)
            Lower   = [char[]](97..122)
            Number  = [char[]](48..57)
          }

          $raw = @()
          $raw += $charSet.Upper  | Get-Random -Count 4
          $raw += $charSet.Lower  | Get-Random -Count 4
          $raw += $charSet.Number | Get-Random -Count 4

          $password = -join ($raw | Sort-Object { Get-Random })
          echo "::add-mask::$password"

          $securePass = ConvertTo-SecureString $password -AsPlainText -Force

          if (-not (Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires
          }

          Add-LocalGroupMember -Group "Users" -Member "RDP"

          echo "RDP_USER=RDP" >> $env:GITHUB_ENV
          echo "RDP_PASS=$password" >> $env:GITHUB_ENV

      - name: Verify User Creation
        shell: pwsh
        run: |
          Get-LocalUser -Name "RDP" | Format-List Name, Enabled, PasswordNeverExpires

